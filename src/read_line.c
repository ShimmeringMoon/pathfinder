#include "pathfinder.h"

/**
 * Читає рядок з файлу до певного роздільника.
 *
 * @param fd Дескриптор файлу.
 * @param size Вказівник на змінну, яка зберігатиме розмір прочитаного рядка.
 * @param eof Вказівник на змінну, що визначає, чи досягнуто кінець файлу.
 * @param delim Символ, що позначає роздільник рядка.
 * @return Прочитаний рядок або NULL, якщо досягнуто кінець файлу.
 */

char *read_line_delim(int fd, int *size, int *eof, char delim) {
    char *line = mx_strnew(256);  // Виділяємо початкову пам'ять
    if (!line) {
        *eof = 1;  // Якщо пам'ять не вдалося виділити
        return NULL;
    }

    int len = 0;  // Поточна довжина рядка
    char c;       // Буфер для зчитування символів

    while (read(fd, &c, 1) > 0) {
        if (c == delim) break;  // Зупиняємо зчитування на роздільнику

        line[len++] = c;

        // Якщо довжина перевищує поточний розмір, розширюємо буфер
        if (len % 256 == 0) {
            line = mx_realloc(line, len + 256);
            if (!line) {
                *eof = 1;  // Помилка при розширенні пам'яті
                return NULL;
            }
        }
    }

    // Перевірка кінця файлу
    if (len == 0 && c != delim) {
        *eof = 1;
        free(line);
        return NULL;
    }

    line[len] = '\0';  // Додаємо нуль-термінатор
    *size = len;       // Повертаємо розмір рядка
    return line;
}
